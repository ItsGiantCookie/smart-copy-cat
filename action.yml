name: 'smart-copy-cat'
description: 'Copies only trigger-specified paths to another repository'
author: 'ItsGiantCookie'

inputs:
  output-repo:
    required: true
    description: 'Owner/TargetRepository'
  output-branch:
    required: true
    description: 'Target branch name'
  path-pattern-to-prune:
    description: 'Path segment to remove (e.g. "start/")'
    default: ''
  path-pattern-to-insert:
    description: 'Replacement path segment (e.g. "target/")'
    default: ''
  git-token:
    required: true
    description: 'PAT with repo write access'

runs:
  using: 'composite'
  steps:
    - name: Initialize
      shell: bash
      run: |
        echo "PR_BRANCH=copy-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV
        echo "TMP_SRCDIR=./source" >> $GITHUB_ENV
        echo "TMP_DSTDIR=./dest" >> $GITHUB_ENV

    - name: Checkout source
      uses: actions/checkout@v4
      with:
        path: ${{ env.TMP_SRCDIR }}
        fetch-depth: 0

    - name: Get trigger paths
      shell: bash
      run: |
        # Extract exactly the paths specified in the workflow trigger
        jq '.push.paths' $GITHUB_EVENT_PATH > trigger_paths.json
        grep -oP '(?<=").*?(?=")' trigger_paths.json | grep -v '\\[*\\]' > changed_files.txt
        echo "TRIGGER_PATHS=$(cat changed_files.txt | tr '\n' ' ')" >> $GITHUB_ENV

    - name: Checkout target
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.output-repo }}
        token: ${{ inputs.git-token }}
        path: ${{ env.TMP_DSTDIR }}

    - name: Configure Git
      shell: bash
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global url."https://${{ inputs.git-token }}@github.com/".insteadOf "https://github.com/"

    - name: Prepare target branch
      working-directory: ${{ env.TMP_DSTDIR }}
      shell: bash
      run: |
        git checkout -b ${{ env.PR_BRANCH }}

    - name: Copy only trigger-specified files
      shell: bash
      run: |
        while IFS= read -r trigger_path; do
          # Handle glob patterns in trigger paths
          for src_file in ${{ env.TMP_SRCDIR }}/$trigger_path; do
            if [ -f "$src_file" ]; then
              # Remove base path and apply transformation
              relative_path=${src_file#${{ env.TMP_SRCDIR }}/}
              dest_file=$(echo "$relative_path" | sed "s|^${{ inputs.path-pattern-to-prune }}|${{ inputs.path-pattern-to-insert }}|")
              
              # Create destination directory
              mkdir -p "${{ env.TMP_DSTDIR }}/$(dirname "$dest_file")"
              
              # Copy file
              cp -v "$src_file" "${{ env.TMP_DSTDIR }}/$dest_file"
            fi
          done
        done < changed_files.txt

    - name: Commit changes
      working-directory: ${{ env.TMP_DSTDIR }}
      shell: bash
      run: |
        git add -A
        git commit -m "Copied only specified trigger paths"
        git push origin ${{ env.PR_BRANCH }}

    - name: Create PR
      shell: bash
      run: |
        curl -X POST \
          -H "Authorization: Bearer ${{ inputs.git-token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ inputs.output-repo }}/pulls" \
          -d '{
            "title": "Update: Copied specified paths only",
            "head": "'${{ env.PR_BRANCH }}'",
            "base": "'${{ inputs.output-branch }}'",
            "body": "Automated copy of exactly the paths specified in workflow trigger"
          }'
        EOF
